steps:
- checkout: self
  clean: true
  fetchDepth: 0
  persistCredentials: true

- task: UseDotNet@2
  condition: eq(variables['IsCanaryBranch'], true)
  inputs:
    packageType: runtime
    version: 2.2.x

- template: templates/gitversion.yml

- template: templates/dotnet-install-linux.yml
  parameters:
    UnoCheckParameters: '--tfm net9.0-browserwasm'

- template: templates/canary-updater.yml

- bash: |
    dotnet publish Uno.Gallery/Uno.Gallery.csproj -c Release -f net9.0-browserwasm -p:UseSkiaRendering=false -p:InformationalVersion=$(GitVersion.InformationalVersion) -o "$(Agent.TempDirectory)/wasm-dom-publish" -bl:$(Build.ArtifactStagingDirectory)/wasm-dom.binlog
  displayName: 'Builds Wasm+DOM'

- task: PublishBuildArtifacts@1
  condition: always()
  retryCountOnTaskFailure: 3
  inputs:
    PathtoPublish: '$(Agent.TempDirectory)/wasm-dom-publish/wwwroot'
    ArtifactName: $(ArtifactName)

- bash: |
    dotnet publish Uno.Gallery/Uno.Gallery.csproj -c Release -f net9.0-browserwasm -p:UseSkiaRendering=true -p:InformationalVersion=$(GitVersion.InformationalVersion) -o "$(Agent.TempDirectory)/wasm-skia-publish" -bl:$(Build.ArtifactStagingDirectory)/wasm-skia.binlog
  displayName: 'Builds Wasm+Skia'

- task: PublishBuildArtifacts@1
  condition: succeeded()
  retryCountOnTaskFailure: 3
  inputs:
    PathtoPublish: '$(Agent.TempDirectory)/wasm-skia-publish/wwwroot'
    ArtifactName: $(ArtifactName)-skia

- task: PublishBuildArtifacts@1
  condition: always()
  retryCountOnTaskFailure: 3
  inputs:
    PathtoPublish: '$(Agent.TempDirectory)'
    ArtifactName: $(ArtifactName)-skialogs
